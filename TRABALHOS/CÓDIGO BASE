from datetime import date, timedelta

class Item:
    def __init__(self, codigo, titulo, ano, estoque=1, tipo="item"):
        self.codigo = codigo
        self.titulo = titulo
        self.ano = ano
        self.estoque = estoque
        self.tipo = tipo

    def dias_de_emprestimo(self):
        return 14

    def __str__(self):
        return f"{self.tipo.title()}('{self.titulo}', {self.ano})"


class Usuario:
    def __init__(self, id_usuario, nome, limite_emprestimos=3):
        self.id_usuario = id_usuario
        self.nome = nome
        self.limite_emprestimos = limite_emprestimos
        self.itens_emprestados = []


class Emprestimo:
    def __init__(self, item, usuario, data=None):
        self.item = item
        self.usuario = usuario
        self.data_emprestimo = data or date.today()
        self.data_devolucao = None
        self.prazo = self.data_emprestimo + timedelta(days=item.dias_de_emprestimo())

    @property
    def em_aberto(self):
        return self.data_devolucao is None

    def devolver(self):
        if not self.em_aberto:
            raise ValueError("Empréstimo já devolvido.")
        self.data_devolucao = date.today()

    def __str__(self):
        status = "aberto" if self.em_aberto else f"devolvido em {self.data_devolucao}"
        return f"[{status}] {self.item} -> {self.usuario.nome} (prazo {self.prazo})"


class Biblioteca:
    def __init__(self, nome):
        self.nome = nome
        self.catalogo = {}
        self.usuarios = {}
        self.emprestimos = []

    def adicionar_item(self, item):
        if item.codigo in self.catalogo:
            raise ValueError("Código já cadastrado.")
        self.catalogo[item.codigo] = item

    def buscar_item(self, codigo):
        if codigo not in self.catalogo:
            raise KeyError("Item não encontrado.")
        return self.catalogo[codigo]

    def cadastrar_usuario(self, usuario):
        if usuario.id_usuario in self.usuarios:
            raise ValueError("Usuário já cadastrado.")
        self.usuarios[usuario.id_usuario] = usuario

    def buscar_usuario(self, id_usuario):
        if id_usuario not in self.usuarios:
            raise KeyError("Usuário não encontrado.")
        return self.usuarios[id_usuario]

    def emprestar(self, id_usuario, codigo_item):
        usuario = self.buscar_usuario(id_usuario)
        item = self.buscar_item(codigo_item)
        if len(usuario.itens_emprestados) >= usuario.limite_emprestimos:
            raise PermissionError("Usuário atingiu o limite de empréstimos.")
        if item.estoque <= 0:
            raise ValueError("Sem unidades disponíveis.")
        item.estoque -= 1
        emp = Emprestimo(item, usuario)
        usuario.itens_emprestados.append(emp)
        self.emprestimos.append(emp)
        return emp

    def devolver(self, id_usuario, codigo_item):
        usuario = self.buscar_usuario(id_usuario)
        item = self.buscar_item(codigo_item)
        alvo = None
        for e in self.emprestimos:
            if e.usuario is usuario and e.item is item and e.em_aberto:
                alvo = e
                break
        if not alvo:
            raise LookupError("Empréstimo em aberto não encontrado.")
        alvo.devolver()
        item.estoque += 1
        usuario.itens_emprestados = [e for e in usuario.itens_emprestados if e is not alvo]

    def listar_itens(self):
        return [f"{i.codigo}: {i} | estoque={i.estoque}" for i in self.catalogo.values()]

    def listar_usuarios(self):
        return [f"{u.id_usuario}: {u.nome} ({len(u.itens_emprestados)} empréstimo(s))"
                for u in self.usuarios.values()]

    def listar_emprestimos_abertos(self):
        return [e for e in self.emprestimos if e.em_aberto]

    def pesquisar_itens(self, termo):
        t = (termo or "").strip().lower()
        if not t:
            return list(self.catalogo.values())
        achados = []
        for item in self.catalogo.values():
            if (t in str(item.codigo).lower()
                or t in str(item.titulo).lower()
                or t in str(item.tipo).lower()):
                achados.append(item)
        return achados

    def pesquisar_usuarios(self, termo):
        t = (termo or "").strip().lower()
        if not t:
            return list(self.usuarios.values())
        achados = []
        for u in self.usuarios.values():
            if (t in str(u.id_usuario).lower()
                or t in str(u.nome).lower()):
                achados.append(u)
        return achados

    def pesquisar_emprestimos(self, termo, status=None):
        t = (termo or "").strip().lower()

        def casa(e):
            alvo = (
                t in str(e.item.codigo).lower()
                or t in str(e.item.titulo).lower()
                or t in str(e.usuario.id_usuario).lower()
                or t in str(e.usuario.nome).lower()
            ) if t else True
            if not alvo:
                return False
            if status == "aberto":
                return e.em_aberto
            if status == "devolvido":
                return not e.em_aberto
            return True

        return [e for e in self.emprestimos if casa(e)]


def demo():
    print(">>> Biblioteca base")
    bib = Biblioteca("Biblioteca Central")
    bib.adicionar_item(Item("I-001", "Clean Code", 2008, estoque=2, tipo="livro"))
    bib.adicionar_item(Item("I-002", "Python Fluente", 2015, estoque=1, tipo="livro"))
    bib.adicionar_item(Item("I-003", "Ciência Hoje #250", 2024, estoque=3, tipo="revista"))
    bib.cadastrar_usuario(Usuario("u1", "Ana", limite_emprestimos=2))
    bib.cadastrar_usuario(Usuario("u2", "Bruno", limite_emprestimos=1))
    bib.emprestar("u1", "I-001")
    bib.emprestar("u1", "I-003")
    bib.emprestar("u2", "I-002")
    bib.devolver("u1", "I-003")

    while True:
        print("\n=== PESQUISAS ===")
        print("[1] Pesquisar ITENS (por código, título ou tipo)")
        print("[2] Pesquisar USUÁRIOS (por id ou nome)")
        print("[3] Pesquisar EMPRÉSTIMOS (por item/usuário)")
        print("[0] Sair")
        op = input("Escolha: ").strip().lower()

        if op == "0":
            print("Até mais...")
            break

        if op == "1":
            termo = input("Termo (se vazio lista todos): ").strip()
            achados = bib.pesquisar_itens(termo)
            if not achados:
                print("  Nenhum item encontrado.")
            else:
                for it in achados:
                    print(f"  {it.codigo}: {it} | estoque={it.estoque}")

        elif op == "2":
            termo = input("Termo (se vazio lista todos): ").strip()
            achados = bib.pesquisar_usuarios(termo)
            if not achados:
                print("  Nenhum usuário encontrado.")
            else:
                for u in achados:
                    print(f"  {u.id_usuario}: {u.nome} | empréstimos={len(u.itens_emprestados)}")

        elif op == "3":
            termo = input("Termo (item/usuário; vazio lista todos): ").strip()
            status = input("Status [enter=Todos | aberto | devolvido]: ").strip().lower() or None
            if status not in (None, "aberto", "devolvido"):
                print("  Status inválido. Usando 'Todos'.")
                status = None
            achados = bib.pesquisar_emprestimos(termo, status=status)
            if not achados:
                print("  Nenhum empréstimo encontrado.")
            else:
                for e in achados:
                    print("  ", e)
        else:
            print("Opção inválida.")


if __name__ == "__main__":
    demo()
